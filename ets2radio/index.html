<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <title>ETS2 Radio Editor</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="/favicon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
<div class="container mx-auto" id="app">
    <h1 class="text-2xl font-bold mb-4">ETS2 Radio Stream Editor</h1>
    <input type="file" id="fileInput" accept=".sii" class="mb-4">
    <div class="mb-4">
        <button id="addBtn" class="px-2 py-1 bg-blue-500 text-white rounded mr-2">Add Station</button>
        <button id="exportBtn" class="px-2 py-1 bg-green-500 text-white rounded">Export</button>
    </div>
    <div class="overflow-x-auto">
    <table class="min-w-full bg-white border">
        <thead class="bg-gray-200">
        <tr>
            <th class="border px-2 py-1">#</th>
            <th class="border px-2 py-1">Drag</th>
            <th class="border px-2 py-1">Name</th>
            <th class="border px-2 py-1">Genre</th>
            <th class="border px-2 py-1">Country</th>
            <th class="border px-2 py-1">Bitrate</th>
            <th class="border px-2 py-1">URL</th>
            <th class="border px-2 py-1">Fav</th>
            <th class="border px-2 py-1">Delete</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
    </div>
</div>
<script>
const tbody = document.getElementById('tbody');
let streams = [];

// Utility functions for UTF-8 encoding/decoding
function decodeUtf8Hex(str) {
    // Convert \xHH sequences to proper UTF-8 characters
    return str.replace(/(?:\\x[0-9a-fA-F]{2})+/g, function(match) {
        // Extract all hex values
        const hexMatches = match.match(/\\x([0-9a-fA-F]{2})/g);
        if (!hexMatches) return match;
        
        // Convert to byte array
        const bytes = hexMatches.map(hex => parseInt(hex.slice(2), 16));
        
        // Convert bytes to UTF-8 string
        try {
            return new TextDecoder('utf-8').decode(new Uint8Array(bytes));
        } catch (e) {
            // If decoding fails, return original
            return match;
        }
    });
}

function encodeUtf8Hex(str) {
    // Convert non-ASCII characters back to \xHH sequences
    return str.replace(/[\u0080-\uFFFF]/g, function(match) {
        const bytes = new TextEncoder().encode(match);
        return Array.from(bytes).map(b => '\\x' + b.toString(16).padStart(2, '0')).join('');
    });
}
function save() {
    localStorage.setItem('ets2radio', JSON.stringify(streams));
}
function loadSaved(){
    const data = localStorage.getItem('ets2radio');
    if(data){
        try{ 
            streams = JSON.parse(data); 
            render(); 
        } catch(e) { 
            console.error(e); 
            alert("Error: Your saved data is corrupted and cannot be loaded. Please reset or re-import your data."); 
        }
    }
}
function parseFile(text){
    const list = [];
    const regex = /stream_data\[\d+\]:\s*"([^"]*)"/g;
    let m;
    while((m = regex.exec(text))){
        const parts = m[1].split('|');
        const name = parts[1] || '';
        const genre = parts[2] || '';
        const country = parts[3] || '';
        
        list.push({
            url: parts[0] || '', 
            name: decodeUtf8Hex(name), 
            nameOriginal: name, // Store original encoded version
            genre: decodeUtf8Hex(genre), 
            genreOriginal: genre, // Store original encoded version
            country: decodeUtf8Hex(country), 
            countryOriginal: country, // Store original encoded version
            bitrate: parts[4] || '', 
            fav: parts[5] || '0'
        });
    }
    return list;
}
function render(){
    tbody.innerHTML = '';
    streams.forEach((s,i)=>{
        const tr = document.createElement('tr');
        tr.setAttribute('draggable','true');
        tr.innerHTML = `
        <td class="border px-2 py-1">${i+1}</td>
        <td class="border px-2 py-1 cursor-move drag-handle">☰</td>
        <td class="border px-2 py-1"><input class="w-full" value="${s.name}" data-idx="${i}" data-field="name"></td>
        <td class="border px-2 py-1"><input class="w-full" value="${s.genre}" data-idx="${i}" data-field="genre"></td>
        <td class="border px-2 py-1"><input class="w-full" value="${s.country}" data-idx="${i}" data-field="country"></td>
        <td class="border px-2 py-1"><input class="w-full" value="${s.bitrate}" data-idx="${i}" data-field="bitrate"></td>
        <td class="border px-2 py-1"><input class="w-full" value="${s.url}" data-idx="${i}" data-field="url"></td>
        <td class="border px-2 py-1 text-center"><input type="checkbox" ${s.fav==1||s.fav==='1'?'checked':''} data-idx="${i}" data-field="fav"></td>
        <td class="border px-2 py-1 text-center">
            <button class="text-sm bg-red-400 text-white px-1" data-act="del" data-idx="${i}">✖</button>
        </td>`;
        tbody.appendChild(tr);
    });
}
function updateField(idx,field,value){
    streams[idx][field]=value;
    // Also update the original encoded version for export
    if(field === 'name') streams[idx].nameOriginal = encodeUtf8Hex(value);
    if(field === 'genre') streams[idx].genreOriginal = encodeUtf8Hex(value);
    if(field === 'country') streams[idx].countryOriginal = encodeUtf8Hex(value);
    save();
}
function addStation(){
    streams.push({
        url:'',
        name:'',
        nameOriginal:'',
        genre:'',
        genreOriginal:'',
        country:'',
        countryOriginal:'',
        bitrate:'128',
        fav:'0'
    });
    render(); save();
}
function removeStation(i){
    streams.splice(i,1); render(); save();
}
let dragIndex=null;
function exportFile(){
    const lines=[];
    lines.push('SiiNunit');
    lines.push('{');
    lines.push('live_stream_def : _nameless.ets2radio {');
    lines.push(' stream_data: '+streams.length);
    streams.forEach((s,i)=>{
        const fav = s.fav==1||s.fav==='1'?1:0;
        // Use original encoded values for export to preserve format
        const nameForExport = s.nameOriginal || encodeUtf8Hex(s.name || '');
        const genreForExport = s.genreOriginal || encodeUtf8Hex(s.genre || '');
        const countryForExport = s.countryOriginal || encodeUtf8Hex(s.country || '');
        lines.push(` stream_data[${i}]: "${s.url}|${nameForExport}|${genreForExport}|${countryForExport}|${s.bitrate}|${fav}"`);
    });
    lines.push('}');
    lines.push('}');
    const blob = new Blob([lines.join('\n')],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='live_streams.sii';a.click();
    URL.revokeObjectURL(url);
}
// event listeners
fileInput.addEventListener('change', (e)=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
        streams=parseFile(ev.target.result); render(); save();
    };
    reader.readAsText(file);
});
addBtn.addEventListener('click', addStation);
exportBtn.addEventListener('click', exportFile);

tbody.addEventListener('input', (e)=>{
    const idx=e.target.getAttribute('data-idx');
    const field=e.target.getAttribute('data-field');
    if(idx !== null && !isNaN(Number(idx)) && field){
        if(e.target.type==='checkbox') updateField(Number(idx),field,e.target.checked?1:0);
        else updateField(Number(idx),field,e.target.value);
    }
});

tbody.addEventListener('click', (e)=>{
    const act=e.target.getAttribute('data-act');
    const idx=e.target.getAttribute('data-idx');
    if(act !== null && idx !== null){
        const i=Number(idx);
        if(act==='del') removeStation(i);
    }
});

tbody.addEventListener('dragstart', e => {
    const tr = e.target.closest('tr');
    dragIndex = tr ? [...tbody.children].indexOf(tr) : null;
});

tbody.addEventListener('dragover', e => {
    e.preventDefault();
    const tr = e.target.closest('tr');
    if(tr) tr.classList.add('bg-gray-100');
});

tbody.addEventListener('dragleave', e => {
    const tr = e.target.closest('tr');
    if(tr) tr.classList.remove('bg-gray-100');
});

tbody.addEventListener('drop', e => {
    e.preventDefault();
    const tr = e.target.closest('tr');
    if(tr){
        tr.classList.remove('bg-gray-100');
        const dropIndex = [...tbody.children].indexOf(tr);
        if(dragIndex!==null && dropIndex!==dragIndex){
            const [item] = streams.splice(dragIndex,1);
            streams.splice(dropIndex,0,item);
            render();
            save();
        }
    }
    dragIndex=null;
});

loadSaved();
</script>
</body>
</html>
